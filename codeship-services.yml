companies:
  build:
    image: jincort/backend-fpm-company
    context: ./
    dockerfile: companies.docker
  ports:
      - "9000:9000"
  env_file: .env.prod.encrypted
  links:
      - auth
      - verify
  cached: true


workspace:
  build:
    image: jincort/backend-company
    context: ./
    args:
      - TZ=UTC
      - INSTALL_XDEBUG=false
    dockerfile: workspace.debug
  tty: true
  links:
    - search
    - auth
    - verify
    - mongo
    - redis
  volumes_from:
    - src

auth:
  image: jincort/backend-auth:production
  environment:
    REDIS_HOST: redis
    REDIS_PORT: 6379
    THROTTLER_WHITE_LIST: 127.0.0.1,10.5.0.2,10.5.0.3
    TENANT_WHITE_LIST: 127.0.0.1,10.5.0.2,10.5.0.3
    FORCE_HTTPS: disabled
    JWT_KEY: "7z3B4gLdSx#fTlAmNnfrYC-;Gp#7fXfOk@cehjUHTWhDjSdcp1"
  volumes:
    - /usr/src/app
  links:
    - redis

verify:
  image: registry.jincor.com/backend/verify:latest
  env_file:
    - .env
  environment:
    REDIS_HOST: redis
    REDIS_PORT: 6379
    MAIL_DRIVER: ${MAIL_DRIVER}
  links:
    - auth

search:
  image: docker.elastic.co/elasticsearch/elasticsearch:5.3.2
  environment:
    - cluster.name=jincor-companies
#    - bootstrap.memory_lock=true
    - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
  ulimits:
    memlock:
      soft: 65536
      hard: 65536
    nofile:
      soft: 65536
      hard: 65536
  mem_limit: 1g
  cap_add:
    - IPC_LOCK
  ports:
    - "9200:9200"

nginx:
  image: registry.jincor.com/backend/nginx:latest
  volumes_from:
    - src
  ports:
   - "80:80"
   - "443:443"
  links:
    - companies

redis:
  image: jincort/backend-redis:production
  volumes:
      - ./storage/redis:/data

mongo:
  image: jincort/backend-mongodb:production
  volumes:
      - ./storage/mongodb:/data/db
  ports:
    - "27017:27017"
    - "28017:28017"

src:
  image: tianon/true
  volumes:
    - ./:/var/www/companies


dockercfg_generator:
  image: codeship/heroku-dockercfg-generator
  add_docker: true
  encrypted_env_file: .env.prod.encrypted
